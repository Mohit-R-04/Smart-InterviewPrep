name: Weekly Data Update

on:
  schedule:
    # Run every Sunday at 00:00 UTC (weekly update)
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm install
        
      - name: Backup current data
        run: |
          echo "ğŸ“¦ Backing up current data..."
          cp public/problems.json public/problems.json.backup || echo "No existing problems.json to backup"
          cp public/metadata.json public/metadata.json.backup || echo "No existing metadata.json to backup"
        
      - name: Fetch real-time LeetCode data
        id: fetch
        run: |
          echo "Fetching LeetCode data (problems + company frequencies)..."
          node scripts/fetch_realtime_data.js
        continue-on-error: true
        
      - name: Verify data integrity
        id: verify
        run: |
          if [ -f "public/problems.json" ]; then
            # Check if file is valid JSON and has data
            if jq -e '. | length > 0' public/problems.json > /dev/null 2>&1; then
              echo "data_valid=true" >> $GITHUB_OUTPUT
              echo "âœ… New data is valid"
            else
              echo "data_valid=false" >> $GITHUB_OUTPUT
              echo "âš ï¸ New data is invalid or empty"
            fi
          else
            echo "data_valid=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No data file generated"
          fi
        
      - name: Restore backup if fetch failed
        if: steps.verify.outputs.data_valid != 'true'
        run: |
          echo "âš ï¸ Fetch failed or data invalid - restoring backup..."
          mv public/problems.json.backup public/problems.json || echo "No backup to restore"
          mv public/metadata.json.backup public/metadata.json || echo "No metadata backup to restore"
          echo "âœ… Using previous week's data"
        
      - name: Clean up backups
        if: steps.verify.outputs.data_valid == 'true'
        run: |
          echo "ğŸ§¹ Cleaning up backups..."
          rm -f public/problems.json.backup public/metadata.json.backup
        
      - name: Commit and push if changed
        if: steps.verify.outputs.data_valid == 'true'
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git add public/problems.json public/metadata.json || true
          git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ¤– Weekly data update: $(date +'%Y-%m-%d')" && git push)
        
      - name: Summary
        if: always()
        run: |
          echo "ğŸ“Š Weekly Update Summary:"
          echo "  Fetch status: ${{ steps.fetch.outcome }}"
          echo "  Data valid: ${{ steps.verify.outputs.data_valid }}"
          if [ "${{ steps.verify.outputs.data_valid }}" == "true" ]; then
            echo "âœ… Database updated with fresh LeetCode data"
          else
            echo "âš ï¸ Using previous data - fetch failed or data invalid"
          fi
          echo "ğŸ“ Note: Curated problems are NOT updated (as requested)"
